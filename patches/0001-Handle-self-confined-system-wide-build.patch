From f1cae2ca26d35073c9cdec8a3c1cae2a23f1d2af Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Claudio=20Andr=C3=A9?= <claudioandre.br@gmail.com>
Date: Sat, 15 Dec 2018 23:35:51 -0200
Subject: [PATCH] Handle self confined system wide build.

---
 src/john.c     | 8 ++++----
 src/listconf.c | 7 +++++++
 src/params.h   | 4 ++--
 src/path.c     | 7 ++++++-
 4 files changed, 19 insertions(+), 7 deletions(-)

diff --git a/src/john.c b/src/john.c
index c7181c8e7..5a22b180c 100644
--- a/src/john.c
+++ b/src/john.c
@@ -486,7 +486,7 @@ static void john_omp_init(void)
 static void john_omp_fallback(char **argv) {
 	if (!getenv("JOHN_NO_OMP_FALLBACK") && john_omp_threads_new <= 1) {
 		rec_done(-2);
-#ifdef JOHN_SYSTEMWIDE_EXEC
+#if defined(JOHN_SYSTEMWIDE_EXEC) && !defined(_BOXED)
 #define OMP_FALLBACK_PATHNAME JOHN_SYSTEMWIDE_EXEC "/" OMP_FALLBACK_BINARY
 #else
 #define OMP_FALLBACK_PATHNAME path_expand("$JOHN/" OMP_FALLBACK_BINARY)
@@ -495,7 +495,7 @@ static void john_omp_fallback(char **argv) {
 		mpi_teardown();
 #endif
 		execv(OMP_FALLBACK_PATHNAME, argv);
-#ifdef JOHN_SYSTEMWIDE_EXEC
+#if defined(JOHN_SYSTEMWIDE_EXEC) && !defined(_BOXED)
 		perror("execv: " OMP_FALLBACK_PATHNAME);
 #else
 		perror("execv: $JOHN/" OMP_FALLBACK_BINARY);
@@ -1472,13 +1472,13 @@ static void CPU_detect_or_fallback(char **argv, int make_check)
 #error CPU_FALLBACK is incompatible with the current DOS code
 #endif
 		if (!make_check) {
-#ifdef JOHN_SYSTEMWIDE_EXEC
+#if defined(JOHN_SYSTEMWIDE_EXEC) && !defined(_BOXED)
 #define CPU_FALLBACK_PATHNAME JOHN_SYSTEMWIDE_EXEC "/" CPU_FALLBACK_BINARY
 #else
 #define CPU_FALLBACK_PATHNAME path_expand("$JOHN/" CPU_FALLBACK_BINARY)
 #endif
 			execv(CPU_FALLBACK_PATHNAME, argv);
-#ifdef JOHN_SYSTEMWIDE_EXEC
+#if defined(JOHN_SYSTEMWIDE_EXEC) && !defined(_BOXED)
 			perror("execv: " CPU_FALLBACK_PATHNAME);
 #else
 			perror("execv: $JOHN/" CPU_FALLBACK_BINARY);
diff --git a/src/listconf.c b/src/listconf.c
index b36b6cfbe..0b0bf85f0 100644
--- a/src/listconf.c
+++ b/src/listconf.c
@@ -142,10 +142,17 @@ static void listconf_list_build_info(void)
 	       SIMD_PARA_SHA256, SIMD_PARA_SHA512);
 #endif
 #if JOHN_SYSTEMWIDE
+#if defined(_BOXED)
+	puts("Deploy: " "sandbox ready");
+	puts("System-wide exec: " "$JOHN/");
+	puts("System-wide home: " "$JOHN/");
+	printf("Private home is %s\n", path_expand(JOHN_PRIVATE_HOME));
+#else
 	puts("System-wide exec: " JOHN_SYSTEMWIDE_EXEC);
 	puts("System-wide home: " JOHN_SYSTEMWIDE_HOME);
 	puts("Private home: " JOHN_PRIVATE_HOME);
 #endif
+#endif
 #if CPU_REQ
 	printf("CPU tests: %s\n", CPU_req_name);
 #endif
diff --git a/src/params.h b/src/params.h
index e65fd5a1c..cb8860c1b 100644
--- a/src/params.h
+++ b/src/params.h
@@ -100,10 +100,10 @@
 
 #if JOHN_SYSTEMWIDE
 #ifndef JOHN_SYSTEMWIDE_EXEC /* please refer to the notes above */
-#define JOHN_SYSTEMWIDE_EXEC		"/usr/libexec/john"
+#define JOHN_SYSTEMWIDE_EXEC		"/app/bin"
 #endif
 #ifndef JOHN_SYSTEMWIDE_HOME
-#define JOHN_SYSTEMWIDE_HOME		"/usr/share/john"
+#define JOHN_SYSTEMWIDE_HOME		"/app/bin"
 #endif
 #define JOHN_PRIVATE_HOME		"~/.john"
 #endif
diff --git a/src/path.c b/src/path.c
index af97e3889..512dbe681 100644
--- a/src/path.c
+++ b/src/path.c
@@ -82,9 +82,14 @@ void path_init(char **argv)
 	} else
 		fprintf(stderr, "Created directory: %s\n", private);
 #endif
-#else
+#endif
+
+#if defined(_SNAP)
+	MEM_FREE(john_home_path);
+
 	if (argv[0]) {
 		int dos=0;
+		char *pos;
 		if (!john_home_path) {
 			pos = strrchr(argv[0], '/');
 			if (!pos) {
-- 
2.19.1

